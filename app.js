// Smart Home App - Minified
let mqttClient=null,msgCount=0;const chartData={labels:[],temp:[],humidity:[],gas:[],light:[]},MAX_POINTS=20;let currentChart='temp';const els={status:document.getElementById('mqtt-status'),statusText:document.getElementById('mqtt-status-text'),lastUpdate:document.getElementById('last-update'),msgCount:document.getElementById('message-count'),log:document.getElementById('log-container'),connectBtn:document.getElementById('connect-btn'),disconnectBtn:document.getElementById('disconnect-btn'),temp:document.getElementById('temp'),humidity:document.getElementById('humidity'),gas:document.getElementById('gas'),light:document.getElementById('light'),motion:document.getElementById('motion'),relay:document.getElementById('relay'),relayOn:document.getElementById('relay-on-btn'),relayOff:document.getElementById('relay-off-btn'),chartCanvas:document.getElementById('sensorChart'),chartTemp:document.getElementById('chart-temp'),chartHumidity:document.getElementById('chart-humidity'),chartGas:document.getElementById('chart-gas'),chartLight:document.getElementById('chart-light'),chartClear:document.getElementById('chart-clear')};const ctx=els.chartCanvas.getContext('2d'),chart=new Chart(ctx,{type:'line',data:{labels:chartData.labels,datasets:[{label:'Temperature (Â°C)',data:chartData.temp,borderColor:'rgb(50, 184, 198)',backgroundColor:'rgba(50, 184, 198, 0.1)',tension:0.4,fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#f5f5f5'}}},scales:{y:{beginAtZero:false,grid:{color:'rgba(119, 124, 124, 0.2)'},ticks:{color:'#f5f5f5'}},x:{grid:{color:'rgba(119, 124, 124, 0.2)'},ticks:{color:'#f5f5f5'}}}}});function updateChart(type){currentChart=type;const configs={temp:{label:'Temperature (Â°C)',data:chartData.temp,color:'rgb(50, 184, 198)',bg:'rgba(50, 184, 198, 0.1)'},humidity:{label:'Humidity (%)',data:chartData.humidity,color:'rgb(100, 149, 237)',bg:'rgba(100, 149, 237, 0.1)'},gas:{label:'Gas (ppm)',data:chartData.gas,color:'rgb(255, 84, 89)',bg:'rgba(255, 84, 89, 0.1)'},light:{label:'Light (lux)',data:chartData.light,color:'rgb(255, 193, 7)',bg:'rgba(255, 193, 7, 0.1)'}};const cfg=configs[type];chart.data.datasets[0].label=cfg.label;chart.data.datasets[0].data=cfg.data;chart.data.datasets[0].borderColor=cfg.color;chart.data.datasets[0].backgroundColor=cfg.bg;chart.update();[els.chartTemp,els.chartHumidity,els.chartGas,els.chartLight].forEach(btn=>btn.classList.remove('active'));document.getElementById('chart-'+type).classList.add('active')}function addDataPoint(t,h,g,l){const time=new Date().toLocaleTimeString();chartData.labels.push(time);chartData.temp.push(t);chartData.humidity.push(h);chartData.gas.push(g);chartData.light.push(l);if(chartData.labels.length>MAX_POINTS){chartData.labels.shift();chartData.temp.shift();chartData.humidity.shift();chartData.gas.shift();chartData.light.shift()}chart.update()}function clearChart(){chartData.labels=[];chartData.temp=[];chartData.humidity=[];chartData.gas=[];chartData.light=[];chart.data.labels=chartData.labels;chart.update();addLog('ðŸ“Š Chart cleared')}function addLog(msg){const time=new Date().toLocaleTimeString(),entry=document.createElement('div');entry.className='log-entry';entry.innerHTML=`<span class="timestamp">[${time}]</span> <span>${msg}</span>`;els.log.insertBefore(entry,els.log.firstChild);while(els.log.children.length>UI_CONFIG.MAX_LOG_ENTRIES){els.log.removeChild(els.log.lastChild)}}function updateStatus(connected){if(connected){els.status.classList.add('connected');els.status.classList.remove('disconnected');els.statusText.textContent='Connected';els.connectBtn.disabled=true;els.disconnectBtn.disabled=false}else{els.status.classList.remove('connected');els.status.classList.add('disconnected');els.statusText.textContent='Disconnected';els.connectBtn.disabled=false;els.disconnectBtn.disabled=true}}function connectMQTT(){addLog('Connecting to MQTT...');const url=`wss://${MQTT_CONFIG.BROKER}:${MQTT_CONFIG.PORT}/mqtt`;mqttClient=mqtt.connect(url,{username:MQTT_CONFIG.USERNAME,password:MQTT_CONFIG.PASSWORD,clientId:MQTT_CONFIG.CLIENT_ID_PREFIX+Math.random().toString(16).substr(2,8),clean:true,reconnectPeriod:5000});mqttClient.on('connect',()=>{addLog('âœ… MQTT connected!');updateStatus(true);Object.values(TOPICS).forEach(topic=>{mqttClient.subscribe(topic,{qos:1},err=>{if(!err){addLog(`ðŸ“¡ Subscribed: ${topic}`)}else{addLog(`âŒ Failed: ${topic}`)}})})});mqttClient.on('message',(topic,message)=>{try{msgCount++;els.msgCount.textContent=msgCount;els.lastUpdate.textContent=new Date().toLocaleTimeString();const payload=message.toString();if(topic===TOPICS.SENSORS_DATA){const data=JSON.parse(payload);updateSensorData(data);addLog(`ðŸ“Š T=${data.temp}Â°C H=${data.humidity}% G=${data.gas}ppm`)}else if(topic===TOPICS.RELAY_STATUS){updateRelayStatus(payload);addLog(`ðŸŽ›ï¸ Relay: ${payload}`)}else if(topic===TOPICS.ALERT){addLog(`âš ï¸ ALERT: ${payload}`)}}catch(e){addLog(`âš ï¸ Error: ${e.message}`)}});mqttClient.on('error',err=>{addLog('âŒ Error: '+err.message);updateStatus(false)});mqttClient.on('close',()=>{addLog('ðŸ”Œ Disconnected');updateStatus(false)})}function updateSensorData(data){if(data.temp!==undefined){els.temp.textContent=data.temp.toFixed(1)}if(data.humidity!==undefined){els.humidity.textContent=data.humidity.toFixed(1)}if(data.gas!==undefined){els.gas.textContent=data.gas;const gasCard=els.gas.closest('.sensor-card');gasCard.style.borderColor=data.gas>100?'var(--color-error)':'rgba(50, 184, 198, 0.3)'}if(data.light!==undefined){els.light.textContent=Math.round(data.light)}if(data.motion!==undefined){const isMotion=data.motion===true||data.motion===1||data.motion==='true';els.motion.textContent=isMotion?'Detected':'Idle';const motionCard=els.motion.closest('.sensor-card');if(isMotion){motionCard.classList.add('motion-detected')}else{motionCard.classList.remove('motion-detected')}}if(data.relay!==undefined){const relayState=data.relay==='ON'||data.relay===true||data.relay===1;updateRelayVisual(relayState)}if(data.temp!==undefined&&data.humidity!==undefined&&data.gas!==undefined&&data.light!==undefined){addDataPoint(data.temp,data.humidity,data.gas,data.light)}}function updateRelayStatus(status){const isOn=status==='ON'||status==='1'||status==='true';updateRelayVisual(isOn)}function updateRelayVisual(isOn){els.relay.textContent=isOn?'ON':'OFF';const relayCard=els.relay.closest('.sensor-card');relayCard.classList.remove('relay-on','relay-off');relayCard.classList.add(isOn?'relay-on':'relay-off')}function controlRelay(action){if(!mqttClient||!mqttClient.connected){addLog('âŒ Not connected');return}const payload=JSON.stringify({action:action});mqttClient.publish(TOPICS.RELAY_CONTROL,payload,{qos:1},err=>{if(err){addLog(`âŒ Failed: ${action}`)}else{addLog(`âœ… Sent: ${action}`)}})}function disconnectMQTT(){if(mqttClient){mqttClient.end();addLog('Disconnecting...')}}els.chartTemp.addEventListener('click',()=>updateChart('temp'));els.chartHumidity.addEventListener('click',()=>updateChart('humidity'));els.chartGas.addEventListener('click',()=>updateChart('gas'));els.chartLight.addEventListener('click',()=>updateChart('light'));els.chartClear.addEventListener('click',clearChart);els.connectBtn.addEventListener('click',connectMQTT);els.disconnectBtn.addEventListener('click',disconnectMQTT);els.relayOn.addEventListener('click',()=>controlRelay('ON'));els.relayOff.addEventListener('click',()=>controlRelay('OFF'));updateStatus(false);
